# AI図表生成システム - ローカル動作確認手順書

このドキュメントでは、AI図表生成システムをローカルPC環境で動作確認するための詳細な手順を説明します。

## 目次

1. [前提条件の確認](#前提条件の確認)
2. [必要なツールのインストール](#必要なツールのインストール)
3. [プロジェクトのセットアップ](#プロジェクトのセットアップ)
4. [環境変数の設定](#環境変数の設定)
5. [依存関係のインストール](#依存関係のインストール)
6. [アプリケーションの起動](#アプリケーションの起動)
7. [動作確認テスト](#動作確認テスト)
8. [トラブルシューティング](#トラブルシューティング)

## 前提条件の確認

### システム要件

- **OS**: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **メモリ**: 最低4GB（推奨8GB以上）
- **ディスク容量**: 最低2GB の空き容量
- **ネットワーク**: インターネット接続（Claude API利用のため）

### 必要なアカウント

- **Anthropic Claude API**: [https://console.anthropic.com/](https://console.anthropic.com/)
  - APIキーの取得が必要です

## 必要なツールのインストール

### 1. Node.js のインストール

#### Windows の場合

1. [Node.js公式サイト](https://nodejs.org/)にアクセス
2. LTS版（推奨版）をダウンロード
3. インストーラーを実行し、指示に従ってインストール
4. インストール確認：
   ```cmd
   node --version
   npm --version
   ```

#### macOS の場合

**Homebrewを使用する場合（推奨）:**
```bash
# Homebrewのインストール（未インストールの場合）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Node.jsのインストール
brew install node@18
```

**公式インストーラーを使用する場合:**
1. [Node.js公式サイト](https://nodejs.org/)からLTS版をダウンロード
2. .pkgファイルを実行してインストール

#### Ubuntu/Linux の場合

```bash
# NodeSourceリポジトリの追加
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# Node.jsのインストール
sudo apt-get install -y nodejs

# インストール確認
node --version
npm --version
```

### 2. Git のインストール

#### Windows の場合

1. [Git for Windows](https://gitforwindows.org/)をダウンロード
2. インストーラーを実行
3. デフォルト設定でインストール

#### macOS の場合

```bash
# Homebrewを使用
brew install git

# またはXcode Command Line Toolsをインストール
xcode-select --install
```

#### Ubuntu/Linux の場合

```bash
sudo apt-get update
sudo apt-get install git
```

### 3. Draw.io CLI のインストール

**方法1: draw.io-export パッケージ（推奨）**

```bash
npm install -g draw.io-export
```

**インストール確認:**
```bash
drawio --help
```

**期待される出力:**
```
drawio.js <source.drawio> -o [target]

Options:
      --help     Show help                                             [boolean]
      --version  Show version number                                   [boolean]
  -F, --fmt      output format                                          [string]
  -o, --output   output file              [string] [required] [default: "a.png"]
```

**方法2: 代替パッケージ（方法1が失敗した場合）**

```bash
# @mattiash/drawio-export を使用
npm install -g @mattiash/drawio-export
```

**方法3: Draw.io デスクトップアプリケーション（最終手段）**

1. [Draw.io公式サイト](https://github.com/jgraph/drawio-desktop/releases)から最新版をダウンロード
2. インストール後、コマンドラインから使用可能になります

**注意:** パッケージ名 `@drawio/drawio-desktop-cli` は存在しません。上記のいずれかの方法を使用してください。

### 4. テキストエディタ（推奨）

- **Visual Studio Code**: [https://code.visualstudio.com/](https://code.visualstudio.com/)
- **推奨拡張機能**:
  - TypeScript and JavaScript Language Features
  - ES7+ React/Redux/React-Native snippets
  - Prettier - Code formatter
  - ESLint

## プロジェクトのセットアップ

### 1. リポジトリのクローン

```bash
# プロジェクトディレクトリに移動
cd /path/to/your/projects

# リポジトリをクローン
git clone <repository-url>
cd ai-diagram-generator
```

### 2. プロジェクト構造の確認

```bash
# プロジェクト構造を確認
ls -la
```

以下のような構造が表示されることを確認：
```
ai-diagram-generator/
├── packages/
│   ├── backend/
│   └── frontend/
├── scripts/
├── docs/
├── package.json
└── README.md
```

## 環境変数の設定

### 1. Anthropic API キーの取得

1. [Anthropic Console](https://console.anthropic.com/)にアクセス
2. アカウントを作成またはログイン
3. API Keys セクションでAPIキーを生成
4. APIキーをコピー（後で使用）

### 2. 環境変数ファイルの作成

#### バックエンド環境変数

```bash
# バックエンドディレクトリに移動
cd packages/backend

# 環境変数ファイルをコピー
cp .env.example .env

# .envファイルを編集
```

**.env ファイルの内容を編集:**
```bash
# 必須設定
ANTHROPIC_API_KEY=your_actual_api_key_here

# その他の設定（デフォルト値で動作）
PORT=3001
NODE_ENV=development
FRONTEND_URL=http://localhost:3000
TEMP_FILE_DIR=./temp
DRAWIO_CLI_PATH=drawio
```

#### フロントエンド環境変数

```bash
# フロントエンドディレクトリに移動
cd ../frontend

# 環境変数ファイルをコピー
cp .env.example .env

# .envファイルを編集
```

**.env ファイルの内容を編集:**
```bash
NEXT_PUBLIC_API_URL=http://localhost:3001
NODE_ENV=development
```

### 3. 環境変数の確認

```bash
# プロジェクトルートに戻る
cd ../..

# 環境変数ファイルが作成されていることを確認
ls -la packages/backend/.env
ls -la packages/frontend/.env
```

**重要**: ANTHROPIC_API_KEYが正しく設定されているか確認：

```bash
# Windows (PowerShell)
Get-Content packages/backend/.env | Select-String "ANTHROPIC_API_KEY"

# macOS/Linux
grep "ANTHROPIC_API_KEY" packages/backend/.env
```

APIキーが `your_actual_api_key_here` のままの場合は、実際のAPIキーに置き換えてください。

## 依存関係のインストール

### 1. ルートレベルの依存関係

```bash
# プロジェクトルートで実行
npm install
```

### 2. ワークスペースの依存関係

```bash
# 全ワークスペースの依存関係をインストール
npm install --workspaces
```

### 3. インストール確認

```bash
# パッケージが正しくインストールされたか確認
npm list --depth=0
```

## アプリケーションの起動

### 1. 開発サーバーの起動

#### 方法1: 両方同時に起動（推奨）

```bash
# プロジェクトルートで実行
npm run dev
```

#### 方法2: 個別に起動

**ターミナル1（バックエンド）:**
```bash
npm run dev:backend
```

**ターミナル2（フロントエンド）:**
```bash
npm run dev:frontend
```

### 2. 起動確認

以下のメッセージが表示されることを確認：

**バックエンド:**
```
🚀 AI Diagram Generator Backend running on port 3001
📊 Health check available at http://localhost:3001/health
🎨 API endpoints available at http://localhost:3001/api
✅ All services initialized successfully
```

**フロントエンド:**
```
▲ Next.js 14.2.31
- Local:        http://localhost:3000
- Network:      http://192.168.x.x:3000

✓ Ready in 2.3s
```

### 3. ブラウザでアクセス

1. ブラウザで [http://localhost:3000](http://localhost:3000) にアクセス
2. AI図表生成システムのメイン画面が表示されることを確認

## 動作確認テスト

### 1. 基本機能テスト

#### テスト1: 画面表示確認

1. ブラウザで [http://localhost:3000](http://localhost:3000) にアクセス
2. 以下の要素が表示されることを確認：
   - ヘッダー「AI Diagram Generator」
   - テキスト入力エリア
   - 「作成」ボタン
   - 結果表示エリア（プレースホルダー）

#### テスト2: Draw.io CLI動作確認

1. コマンドラインで以下を実行：
   ```bash
   drawio --version
   ```
2. バージョン番号が表示されることを確認（例：`0.3.0`）

3. 簡単なテストファイルで動作確認：
   ```bash
   # テスト用の簡単な.drawioファイルを作成（任意）
   # または既存の.drawioファイルがある場合はそれを使用
   drawio test.drawio -F png -o test.png
   ```

#### テスト3: API接続確認

1. ブラウザで [http://localhost:3001/health](http://localhost:3001/health) にアクセス
2. 以下のようなJSONレスポンスが表示されることを確認：
   ```json
   {
     "status": "ok",
     "timestamp": "2024-01-01T00:00:00.000Z",
     "service": "ai-diagram-generator-backend"
   }
   ```

#### テスト4: 図表生成テスト

1. メイン画面のテキストエリアに以下を入力：
   ```
   ユーザー登録からログインまでのフローチャートを作成してください
   ```

2. 「作成」ボタンをクリック

3. 以下の動作を確認：
   - ローディングスピナーが表示される
   - ボタンが無効化される
   - 処理完了後、PNG画像が表示される
   - ダウンロードリンクが表示される

4. ダウンロードリンクをクリックして.drawioファイルがダウンロードされることを確認

### 2. エラーハンドリングテスト

#### テスト1: 空入力テスト

1. テキストエリアを空のままにして「作成」ボタンをクリック
2. 適切なエラーメッセージが表示されることを確認

#### テスト2: API接続エラーテスト

1. バックエンドサーバーを停止
2. フロントエンドで図表生成を試行
3. 接続エラーメッセージが表示されることを確認

### 3. レスポンシブデザインテスト

1. ブラウザの開発者ツールを開く（F12）
2. デバイスシミュレーションモードに切り替え
3. 以下のデバイスサイズで表示確認：
   - スマートフォン（375px幅）
   - タブレット（768px幅）
   - デスクトップ（1200px幅）

### 4. パフォーマンステスト

#### 応答時間の確認

1. ブラウザの開発者ツールのNetworkタブを開く
2. 図表生成を実行
3. API応答時間を確認（通常10-30秒程度）

#### メモリ使用量の確認

```bash
# バックエンドのメモリ使用量確認
curl http://localhost:3001/health
# レスポンスヘッダーのX-Memory-Usageを確認
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. Node.js バージョンエラー

**エラー:** `Node.js version 18 or higher is required`

**解決方法:**
```bash
# Node.jsバージョン確認
node --version

# バージョンが18未満の場合、最新版をインストール
# Windows: 公式サイトから最新版をダウンロード
# macOS: brew upgrade node
# Linux: NodeSourceリポジトリから最新版をインストール
```

#### 2. Draw.io CLI エラー

**エラー:** `drawio: command not found`

**解決方法:**
```bash
# Draw.io CLIの再インストール
npm uninstall -g draw.io-export
npm install -g draw.io-export

# インストール確認
drawio --help
```

**エラー:** `@drawio/drawio-desktop-cli@* is not in this registry`

**解決方法:**
上記のパッケージ名は存在しません。正しいパッケージ名は `draw.io-export` です：
```bash
npm install -g draw.io-export
```

**エラー:** `draw.io-export` インストール時の警告

**解決方法:**
以下の警告は無視して構いません（機能に影響しません）：
- `npm warn deprecated puppeteer@14.4.1`
- `npm warn deprecated inflight@1.0.6`
- `npm warn deprecated rimraf@3.0.2`

**エラー:** Draw.io CLIのコマンドオプションエラー

**解決方法:**
`draw.io-export` パッケージのコマンド形式は以下の通りです：
```bash
# 正しい形式
drawio input.drawio -F png -o output.png

# 間違った形式（古いドキュメントに記載されている場合があります）
drawio --export --format png --output output.png input.drawio
```

#### 3. ANTHROPIC_API_KEY エラー

**エラー:** `ANTHROPIC_API_KEY environment variable is required`

**解決方法:**
1. `packages/backend/.env`ファイルを確認
2. APIキーが正しく設定されているか確認
3. APIキーの有効性をAnthropic Consoleで確認

#### 4. ポート使用中エラー

**エラー:** `Port 3000 is already in use`

**解決方法:**
```bash
# 使用中のプロセスを確認
# Windows
netstat -ano | findstr :3000

# macOS/Linux
lsof -i :3000

# プロセスを終了するか、別のポートを使用
PORT=3002 npm run dev:frontend
```

#### 5. 依存関係エラー

**エラー:** `Module not found` または `Cannot resolve dependency`

**解決方法:**
```bash
# node_modulesとpackage-lock.jsonを削除
rm -rf node_modules package-lock.json
rm -rf packages/*/node_modules packages/*/package-lock.json

# 依存関係を再インストール
npm install
npm install --workspaces
```

#### 6. TypeScript エラー

**エラー:** TypeScript compilation errors

**解決方法:**
```bash
# 型チェック実行
npm run typecheck

# エラーがある場合、該当ファイルを確認・修正
# または開発モードでは型エラーを無視して続行
```

#### 7. LLMサービス初期化エラー

**エラー:** `Cannot read properties of undefined (reading 'llmService')`

**解決方法:**
1. ANTHROPIC_API_KEYが正しく設定されているか確認：
   ```bash
   # packages/backend/.env ファイルを確認
   cat packages/backend/.env
   ```
2. APIキーが有効かAnthropic Consoleで確認
3. バックエンドを再起動：
   ```bash
   # Ctrl+C でサーバーを停止してから
   npm run dev:backend
   ```

#### 8. HTTPヘッダーエラー

**エラー:** `Error [ERR_HTTP_HEADERS_SENT]: Cannot set headers after they are sent`

**解決方法:**
1. バックエンドサーバーを完全に停止：
   ```bash
   # Ctrl+C を複数回押すか、プロセスを強制終了
   # Windows
   taskkill /f /im node.exe
   
   # macOS/Linux
   pkill -f node
   ```
2. サーバーを再起動：
   ```bash
   npm run dev:backend
   ```

#### 9. 画像生成エラー

**エラー:** PNG画像が生成されない

**解決方法:**
1. Draw.io CLIが正しくインストールされているか確認
2. 一時ファイルディレクトリの権限を確認
3. バックエンドログを確認：
   ```bash
   # バックエンドのログを確認
   npm run dev:backend
   ```

### ログの確認方法

#### バックエンドログ

```bash
# 開発モードでバックエンドを起動（詳細ログ表示）
cd packages/backend
npm run dev
```

#### フロントエンドログ

```bash
# ブラウザの開発者ツールのConsoleタブでエラーを確認
# または
cd packages/frontend
npm run dev
```

### パフォーマンス問題の対処

#### 1. 応答が遅い場合

- インターネット接続速度を確認
- Claude APIの応答時間を確認
- バックエンドのメモリ使用量を確認

#### 2. メモリ不足の場合

```bash
# Node.jsのメモリ制限を増加
export NODE_OPTIONS="--max-old-space-size=4096"
npm run dev
```

## 動作確認チェックリスト

### 基本機能

- [ ] Node.js 18以上がインストールされている
- [ ] Draw.io CLI（`draw.io-export`）がインストールされている
- [ ] `drawio --version` コマンドが動作する
- [ ] 環境変数が正しく設定されている（ANTHROPIC_API_KEY）
- [ ] 依存関係がインストールされている
- [ ] バックエンドサーバーが起動している（ポート3001）
- [ ] フロントエンドサーバーが起動している（ポート3000）
- [ ] ヘルスチェックAPIが応答する
- [ ] メイン画面が正しく表示される

### 図表生成機能

- [ ] テキスト入力ができる
- [ ] 「作成」ボタンが動作する
- [ ] ローディング表示が出る
- [ ] PNG画像が生成・表示される
- [ ] .drawioファイルがダウンロードできる
- [ ] エラーハンドリングが動作する

### レスポンシブデザイン

- [ ] スマートフォンサイズで正しく表示される
- [ ] タブレットサイズで正しく表示される
- [ ] デスクトップサイズで正しく表示される

### パフォーマンス

- [ ] API応答時間が妥当（30秒以内）
- [ ] メモリ使用量が適切
- [ ] エラーログが出ていない

## 次のステップ

動作確認が完了したら、以下を検討してください：

1. **テストの実行**: `npm test` でユニットテストを実行
2. **コード品質チェック**: `npm run lint` でコード品質を確認
3. **本番環境デプロイ**: `docs/本番環境デプロイ手順.md` を参照
4. **カスタマイズ**: 要件に応じた機能追加・修正

## サポート

問題が解決しない場合は、以下の情報を含めてサポートに連絡してください：

- OS とバージョン
- Node.js バージョン
- エラーメッセージの全文
- 実行したコマンドの履歴
- ログファイルの内容

---

**最終更新日**: 2024年8月4日  
**バージョン**: 1.0